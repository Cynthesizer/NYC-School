<html>
<head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/topojson.v2.min.js"></script>

<style>
body {
    font: 14px Arial;
}

.background {
  fill: rgb(255, 255, 255);
  pointer-events: all;
}

.map-layer {
  fill: rgb(184, 179, 179);
  stroke: rgb(61, 60, 60);
}
.feature {
  /* fill: #ccc; */
  cursor: pointer;
}

.feature.active {
  fill: orange;
}

svg { border: solid #ccc 1px; }

#states {
  fill: #aaa;
}


</style>
</head>
<body>

<svg id="p1"></svg>
<svg id="p2"></svg>

<script>

var stats;
var districts;
var projection;

d3.csv("Data.csv", function(error, datum) {
  stats = datum;

  districts = d3.nest()
  .key(function(d) { return d.district; })
  .entries(datum);

  var colorScale = d3.scaleLinear()
  .domain([200,800])
  .range(['#fff', "#409A99"])

  d3.json('school_districts.geo.json', function(error, mapData) {
      if (error) throw error;
      var data = mapData;

      var features = data.features;

      var width = 960,
      height = 700,
      centered,
      active = d3.select(null);


      projection = d3.geoMercator()
      .fitSize([width,height], data)
      // Center the Map in Colombia

      var color = d3.scaleLinear()
      .domain([1, 20])
      .clamp(true)
      .range(['#fff', '#409A99']);

      var path = d3.geoPath()
      .projection(projection);

      var svg = d3.select('#p1')
      .attr('width', width)
      .attr('height', height)
      .on("click", stopped, true);;


      var g = svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)
      .on("click", reset);
        //.attr("id", "states")

      var maplayer = svg.append('g')
      .classed('map-layer', true);


      var zoom = d3.zoom()
      // no longer in d3 v4 - zoom initialises with zoomIdentity, so it's already at origin
      // .translate([0, 0])
      // .scale(1)
      .scaleExtent([1, 8])
      .on("zoom", zoomed);



      function zoomed() {
      maplayer.style("stroke-width", 1.5 / d3.event.transform.k + "px");
      // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
      maplayer.attr("transform", d3.event.transform); // updated for d3 v4
      }

      function reset() {
      active.classed("active", false);
      active = d3.select(null);

      svg.transition()
          .duration(750)
          // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
          .call( zoom.transform, d3.zoomIdentity ); // updated for d3 v4
      }

      maplayer.selectAll('path')
        .data(features)
        .enter()
        .append('path')
        .attr('d', path)
        //.attr('vector-effect', 'non-scaling-stroke')
        .attr("class","feature")
        .style('fill', d => colorScale(districts[d.properties.SchoolDist - 1].values[0].avgSAT_Math))
        .style('stroke', 'black')
        //.on('mouseover', mouseover)
        //.on('mouseout',mouseout)
        .on('click', clicked)

        maplayer.selectAll("circle")
    		.data(stats).enter()
    		.append("circle")
    		.attr("cx", d => projection([d.Longitude, d.Latitude])[0])
    		.attr("cy", d => projection([d.Longitude, d.Latitude])[1])
    		.attr("r", "8px")
    		.attr("fill", "red")

      function mouseover(d){
      // Highlight hovered province
      d3.select(this).style('fill', 'orange');

      }

      function mouseout(d){
      // Reset province color
      maplayer.selectAll('path')
          .style('fill', function(d){return 'blue';});

      }

      function clicked(d) {

      if (active.node() === this) return reset();
      active.classed("active", false);
      active = d3.select(this).classed("active", true);

      var bounds = path.bounds(d),
          dx = bounds[1][0] - bounds[0][0],
          dy = bounds[1][1] - bounds[0][1],
          x = (bounds[0][0] + bounds[1][0]) / 2,
          y = (bounds[0][1] + bounds[1][1]) / 2,
          scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height))),
          translate = [width / 2 - scale * x, height / 2 - scale * y];

      svg.transition()
          .duration(750)
          //.call(zoom.translate(translate).scale(scale).event); // not in d3 v4
          .call(zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) ); // updated for d3 v4
          //.attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + scale + ')translate(' + -dx + ',' + -dy + ')');
      }


      function stopped() {
      if (d3.event.defaultPrevented) d3.event.stopPropagation();
      }


      /*
      function clicked(d) {
      var x, y, k;

      // Compute centroid of the selected path
      if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = centroid[0];
          y = centroid[1];
          k = 4;
          centered = d;
      } else {
          x = width / 2;
          y = height / 2;
          k = 1;
          centered = null;
      }

      // Highlight the clicked province
      maplayer.selectAll('path')
          .style('fill', function(d){return centered && d===centered ? 'red' : 'blue';});

      // Zoom
      g.transition()
          .duration(750)
          .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')scale(' + k + ')translate(' + -x + ',' + -y + ')');
      }

      */


  });

});








</script>

</body>
</html>
